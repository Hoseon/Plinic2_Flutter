import 'dart:async';

import 'package:flutter/material.dart';
import 'package:flutter_animated_dialog/flutter_animated_dialog.dart';
import 'package:get/get.dart';
import 'package:plinic2/constants.dart';
import 'package:plinic2/src/component/loading.dart';
import 'package:plinic2/src/component/plinic_dialog_one_button.dart';
import 'package:plinic2/src/component/plinic_dialog_two_button.dart';
import 'package:plinic2/src/controller/ble/ble_controller.dart';
import 'package:plinic2/src/pages/ble_connect/ble_care_complete.dart';
import 'package:plinic2/src/pages/ble_connect/components/video_player.dart';
import 'package:plinic2/src/restclient/DeviceLogClient.dart';

//ÍπÉÌóàÎ≥¥ Ïä§ÏÜå Ïò¨Î¶º
class BleCareV2Page extends GetView<BLEController> {
  BleCareV2Page({Key? key}) : super(key: key);
  DeviceLogResponse? deviceLogResponse;

  @override
  Widget build(BuildContext context) {
    return Obx(() => controller.isBleTimeOff.value
        ? completeDevice()
        : WillPopScope(
            onWillPop: () async {
              return false;
            },
            child: Scaffold(
              appBar: AppBar(
                centerTitle: true,
                backgroundColor: black,
                leading: SizedBox(),
                elevation: 0.0,
                title: Text(
                  'ÏºÄÏñ¥Î™®Îìú',
                  style: TextStyle(
                    fontFamily: 'NotoSansKR',
                    color: white,
                    fontSize: 16,
                    fontWeight: FontWeight.w700,
                    fontStyle: FontStyle.normal,
                  ),
                ),
              ),
              backgroundColor: black,
              body: Column(
                children: [
                  AssetVideoPlayerWidget(),
                  // SizedBox(height: 10),
                  // Container(
                  //   padding: const EdgeInsets.symmetric(horizontal: spacing_xl),
                  //   alignment: Alignment.centerLeft,
                  //   child: Text('üåø[Ïù¥ÎãàÏä§ÌîÑÎ¶¨] Í∑∏Î¶∞Ìã∞ Î∞∏Îü∞Ïã± Ïä§ÌÇ®ÏºÄÏñ¥ ÏÑ∏Ìä∏ üåø',
                  //       style: TextStyle(
                  //         fontFamily: 'NotoSansKR',
                  //         color: grey_2,
                  //         fontSize: 12,
                  //         fontWeight: FontWeight.w400,
                  //         fontStyle: FontStyle.normal,
                  //       )),
                  // ),
                  // Container(
                  //   padding: const EdgeInsets.symmetric(horizontal: spacing_xl),
                  //   alignment: Alignment.centerLeft,
                  //   child: TextButton(
                  //     onPressed: () {},
                  //     child: Text('Ï†úÌíàÏ†ïÎ≥¥ Îçî ÏïåÏïÑÎ≥¥Í∏∞',
                  //         style: TextStyle(
                  //           fontFamily: 'NotoSansKR',
                  //           color: primary,
                  //           fontSize: 12,
                  //           fontWeight: FontWeight.w400,
                  //           fontStyle: FontStyle.normal,
                  //         ),
                  //         textAlign: TextAlign.left),
                  //   ),
                  // ),
                  SizedBox(height: 55),
                  Text('ÌîºÎ∂ÄÍ∞Ä Ï¢ãÏïÑÏßÄÎäî ÏãúÍ∞ÑÏûÖÎãàÎã§.',
                      style: TextStyle(
                        fontFamily: 'NotoSansKR',
                        color: grey_2,
                        fontSize: 14,
                        fontWeight: FontWeight.w400,
                        fontStyle: FontStyle.normal,
                      )),
                  SizedBox(height: 30),
                  Text(
                    TimerTextFormatter.format(controller.bleTime.value),
                    style: TextStyle(
                      fontFamily: 'Roboto',
                      color: white,
                      fontSize: 40,
                      fontWeight: FontWeight.w700,
                      fontStyle: FontStyle.normal,
                    ),
                  ),
                  SizedBox(height: spacing_xs),
                  Text('ÏºÄÏñ¥ ÏãúÍ∞Ñ ÏïàÎÇ¥',
                      style: TextStyle(
                        fontFamily: 'NotoSansKR',
                        color: grey_2,
                        fontSize: 14,
                        fontWeight: FontWeight.w400,
                        fontStyle: FontStyle.normal,
                      )),
                  Expanded(child: SizedBox(height: 1)),
                  controller.isNewDevice.value
                      ? Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 55),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Column(
                                children: [
                                  controller.isLowBattery.value
                                      ? Image.asset(
                                          'assets/images/battery-full-solid-default.png',
                                          width: 44)
                                      : Image.asset(
                                          'assets/images/bluetooth-battery.png',
                                          width: 44),
                                  SizedBox(height: spacing_xxs),
                                  controller.isLowBattery.value
                                      ? Text('Ï∂©Ï†Ñ ÌïÑÏöî',
                                          style: TextStyle(
                                            fontFamily: 'NotoSansKR',
                                            color: grey_2,
                                            fontSize: 12,
                                            fontWeight: FontWeight.w400,
                                            fontStyle: FontStyle.normal,
                                          ))
                                      : Text('Ï∂©Ï†Ñ Î∂àÌïÑÏöî',
                                          style: TextStyle(
                                            fontFamily: 'NotoSansKR',
                                            color: grey_2,
                                            fontSize: 12,
                                            fontWeight: FontWeight.w400,
                                            fontStyle: FontStyle.normal,
                                          ))
                                ],
                              ),
                              InkWell(
                                borderRadius: BorderRadius.circular(10),
                                onTap: () {
                                  exitDialog(context);
                                  // Get.offAllNamed('/tabs');
                                  // BLEController.to.bleOff();
                                },
                                child: Column(
                                  children: [
                                    Image.asset(
                                        'assets/images/bluetooth-device.png',
                                        width: 44),
                                    SizedBox(height: spacing_xxs),
                                    Text('Í∏∞Í∏∞ Ï†ÑÏõê Ï¢ÖÎ£å',
                                        style: TextStyle(
                                          fontFamily: 'NotoSansKR',
                                          color: grey_2,
                                          fontSize: 12,
                                          fontWeight: FontWeight.w400,
                                          fontStyle: FontStyle.normal,
                                        ))
                                  ],
                                ),
                              ),
                              InkWell(
                                borderRadius: BorderRadius.circular(10),
                                onTap: () {
                                  controller.isSoundOn.value
                                      ? controller.bleSoundOff()
                                      : controller.bleSoundOn();
                                },
                                child: Column(
                                  children: [
                                    controller.isSoundOn.value
                                        ? Image.asset(
                                            'assets/images/bluetooth-mute.png',
                                            width: 44)
                                        : Image.asset(
                                            'assets/images/deaf-solid-default.png',
                                            width: 44),
                                    SizedBox(height: spacing_xxs),
                                    Text('Í∏∞Í∏∞ ÏùåÏÜåÍ±∞',
                                        style: TextStyle(
                                          fontFamily: 'NotoSansKR',
                                          color: grey_2,
                                          fontSize: 12,
                                          fontWeight: FontWeight.w400,
                                          fontStyle: FontStyle.normal,
                                        ))
                                  ],
                                ),
                              )
                            ],
                          ),
                        )
                      : Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 46),
                          child: ElevatedButton(
                            style: ButtonStyle(
                              backgroundColor:
                                  MaterialStateProperty.all(primary),
                              minimumSize: MaterialStateProperty.all(
                                Size(Get.mediaQuery.size.width, 44),
                              ),
                            ),
                            onPressed: () async {
                              exitDialog(context);
                            },
                            child: Text('ÏºÄÏñ¥ Ï¢ÖÎ£åÌïòÍ∏∞',
                                style: TextStyle(
                                  fontFamily: 'NotoSansKR',
                                  color: white,
                                  fontSize: 14,
                                  fontWeight: FontWeight.w700,
                                  fontStyle: FontStyle.normal,
                                )),
                          ),
                        ),
                  SizedBox(height: Get.mediaQuery.size.height * 0.05)
                ],
              ),
            ),
          ));
  }

  void exitDialog(context) async {
    await showAnimatedDialog(
      context: context,
      barrierDismissible: true,
      animationType: DialogTransitionType.fade,
      curve: Curves.fastOutSlowIn,
      builder: (BuildContext context) {
        return PlinicDialogTwoButton(
          title: 'ÏïåÎ¶º',
          content: 'ÏºÄÏñ¥Í∞Ä ÏßÑÌñâÏ§ëÏûÖÎãàÎã§.\nÏÇ¨Ïö©ÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
          button1Text: 'Í≥ÑÏÜç ÏßÑÌñâÌï†ÍªòÏöî.',
          button2Text: 'ÎÑ§, Ï¢ÖÎ£åÌï†ÍªòÏöî',
          button1Click: () {
            Get.back();
          },
          button2Click: () async {
            if (BLEController.to.isNewDevice.value) {
              await BLEController.to.bleOff(); //v2ÎîîÎ∞îÏù¥Ïä§ ÏùºÍ≤ΩÏö∞ Ï†ÑÏõê offÏ¢ÖÎ£å Î≥¥ÎÉÑ
            } else {
              await BLEController.to.v1_disconnect();
            }
            Get.back();

            //Ïó¨Í∏∞ ÎàÑÏ†Å ÌåùÏóÖ Î∂àÎü¨Ïò§Í∏∞
            // await BLEController.to.saveDeviceLog().then((value) async {
            //   deviceLogResponse = value;
            //   Get.back();
            //   await Get.to(() => BleCareCompletePage(
            //         deviceLogResponse: deviceLogResponse!,
            //       ));
            //   // await savedDialog(context, deviceLogResponse!);
            // });
          },
        );
      },
    );
  }

  Future<void> savedDialog(context, DeviceLogResponse deviceLogResponse) async {
    await showAnimatedDialog(
      context: context,
      barrierDismissible: false,
      animationType: DialogTransitionType.fade,
      curve: Curves.fastOutSlowIn,
      builder: (BuildContext context) {
        return PlinicDialogOneButton(
          title:
              'Ïò§ÎäòÏùò ÏÇ¨Ïö© ${TimerTextFormatter.format(deviceLogResponse.pointsum!)}',
          content: 'ÏºÄÏñ¥Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.\nÏõîÍ∞Ñ ÌîåÎ¶¨ÎãâÏúºÎ°ú Í∏∞Î°ùÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî',
          buttonText: 'ÌôïÏù∏',
          buttonClick: () async {
            Get.back();
            await Get.offAllNamed('/tabs');
          },
        );
      },
    );
  }

  Widget completeDevice() {
    return FutureBuilder(
        future: controller.test(),
        builder: (_, AsyncSnapshot snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return LoadingPage();
          }

          if (snapshot.hasData) {
            deviceLogResponse = snapshot.data as DeviceLogResponse;
            return BleCareCompletePage(deviceLogResponse: deviceLogResponse);
          }
          return LoadingPage();
        });
  }
}

class TimerTextFormatter {
  static String format(int seconds) {
    // var hundreds = (milliseconds / 10).truncate();
    // var seconds = (hundreds / 100).truncate();
    var minutes = (seconds / 60).truncate();
    var hours = (minutes / 60).truncate();

    var minutesStr = (minutes % 60).toString().padLeft(2, '0');
    var secondsStr = (seconds % 60).toString().padLeft(2, '0');
    var hooursStr = (minutes % 60).toString().padLeft(2, '0');
    // var hundredsStr = (hundreds % 100).toString().padLeft(2, '0');

    // return "$minutesStr:$secondsStr.$hundredsStr"; //2021-09-24 ÎØ∏Î¶¨ÏÑ∏Ïª®Îìú ÍπåÏßÄ ÌëúÌòÑ
    return '$minutesStr:$secondsStr';
  }
}
